name: YouTube ReVanced Patcher

on:
  workflow_dispatch:
    inputs:
      apk_url:
        description: 'YouTube APK Download URL (from APKMirror or APKPure)'
        required: false
        type: string
        default: ''
      version:
        description: 'YouTube Version (e.g., 19.16.39)'
        required: true
        type: string
      include_patches:
        description: 'Include specific patches (comma-separated, leave empty for recommended patches)'
        required: false
        type: string
        default: ''
      exclude_patches:
        description: 'Exclude specific patches (comma-separated)'
        required: false
        type: string
        default: ''

jobs:
  patch-youtube:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Download or use existing YouTube APK
        run: |
          if [ -n "${{ github.event.inputs.apk_url }}" ]; then
            echo "ðŸ“¥ Downloading APK from provided URL..."
            wget --user-agent="Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36" \
                 --timeout=60 \
                 --tries=3 \
                 -O youtube.apk "${{ github.event.inputs.apk_url }}"
            
            if [ $? -eq 0 ] && [ -f youtube.apk ]; then
              echo "âœ… APK downloaded successfully"
            else
              echo "âŒ Download failed!"
              exit 1
            fi
          elif [ -f "youtube-source.apk" ]; then
            echo "ðŸ“¦ Using youtube-source.apk from repository"
            cp youtube-source.apk youtube.apk
          elif [ -f "youtube.apk" ]; then
            echo "ðŸ“¦ Using youtube.apk from repository"
          else
            echo "âŒ ERROR: No APK source provided!"
            echo ""
            echo "Please either:"
            echo "  1. Provide 'apk_url' input when running workflow"
            echo "  2. Commit 'youtube-source.apk' or 'youtube.apk' to repository root"
            exit 1
          fi
          
          echo ""
          echo "ðŸ“Š APK Info:"
          ls -lh youtube.apk
          file youtube.apk

      - name: Verify APK integrity
        run: |
          echo "ðŸ” Verifying APK..."
          
          # Check if file is a valid ZIP (APK is a ZIP file)
          if unzip -t youtube.apk > /dev/null 2>&1; then
            echo "âœ… APK file structure is valid"
          else
            echo "âŒ APK file appears to be corrupted"
            exit 1
          fi

      - name: Create directories
        run: |
          mkdir -p apks/original
          mkdir -p apks/patched
          mkdir -p logs

      - name: Save original APK
        run: |
          cp youtube.apk apks/original/youtube-${{ github.event.inputs.version }}-arm64-v8a.apk
          echo "âœ… Original APK saved to apks/original/"

      - name: Download ReVanced tools
        run: |
          echo "ðŸ“¥ Downloading ReVanced tools..."
          echo ""
          
          echo "Fetching ReVanced CLI..."
          CLI_URL=$(curl -s https://api.github.com/repos/revanced/revanced-cli/releases/latest | \
                    jq -r '.assets[] | select(.name | endswith(".jar")) | .browser_download_url')
          CLI_VERSION=$(curl -s https://api.github.com/repos/revanced/revanced-cli/releases/latest | jq -r '.tag_name')
          echo "Version: $CLI_VERSION"
          wget -q --show-progress -O revanced-cli.jar "$CLI_URL"
          
          echo ""
          echo "Fetching ReVanced Patches..."
          PATCHES_URL=$(curl -s https://api.github.com/repos/revanced/revanced-patches/releases/latest | \
                        jq -r '.assets[] | select(.name | endswith(".rvp")) | .browser_download_url')
          PATCHES_VERSION=$(curl -s https://api.github.com/repos/revanced/revanced-patches/releases/latest | jq -r '.tag_name')
          echo "Version: $PATCHES_VERSION"
          wget -q --show-progress -O revanced-patches.rvp "$PATCHES_URL"
          
          echo ""
          echo "Fetching ReVanced Integrations..."
          INTEGRATIONS_URL=$(curl -s https://api.github.com/repos/revanced/revanced-integrations/releases/latest | \
                             jq -r '.assets[] | select(.name | endswith(".apk")) | .browser_download_url')
          INTEGRATIONS_VERSION=$(curl -s https://api.github.com/repos/revanced/revanced-integrations/releases/latest | jq -r '.tag_name')
          echo "Version: $INTEGRATIONS_VERSION"
          wget -q --show-progress -O revanced-integrations.apk "$INTEGRATIONS_URL"
          
          echo ""
          echo "âœ… All ReVanced tools downloaded"
          echo ""
          echo "ðŸ“Š Downloaded files:"
          ls -lh revanced-cli.jar revanced-patches.rvp revanced-integrations.apk
          
          # Save versions to file
          echo "CLI_VERSION=$CLI_VERSION" >> versions.txt
          echo "PATCHES_VERSION=$PATCHES_VERSION" >> versions.txt
          echo "INTEGRATIONS_VERSION=$INTEGRATIONS_VERSION" >> versions.txt

      - name: List available patches
        run: |
          echo "ðŸ“‹ Available patches for YouTube:"
          java -jar revanced-cli.jar list-patches \
            --with-packages \
            --with-versions \
            revanced-patches.rvp | grep -i youtube | tee logs/available-patches.txt

      - name: Patch YouTube APK with ReVanced
        run: |
          echo "ðŸ”§ Starting patching process..."
          echo ""
          
          # Build patch command
          PATCH_CMD="java -jar revanced-cli.jar patch"
          PATCH_CMD="$PATCH_CMD --patch-bundle revanced-patches.rvp"
          PATCH_CMD="$PATCH_CMD --merge revanced-integrations.apk"
          PATCH_CMD="$PATCH_CMD --out youtube-revanced.apk"
          
          # Add include patches if specified
          if [ -n "${{ github.event.inputs.include_patches }}" ]; then
            echo "Including specific patches: ${{ github.event.inputs.include_patches }}"
            IFS=',' read -ra PATCHES <<< "${{ github.event.inputs.include_patches }}"
            for patch in "${PATCHES[@]}"; do
              PATCH_CMD="$PATCH_CMD --include $(echo $patch | xargs)"
            done
          fi
          
          # Add exclude patches if specified
          if [ -n "${{ github.event.inputs.exclude_patches }}" ]; then
            echo "Excluding patches: ${{ github.event.inputs.exclude_patches }}"
            IFS=',' read -ra PATCHES <<< "${{ github.event.inputs.exclude_patches }}"
            for patch in "${PATCHES[@]}"; do
              PATCH_CMD="$PATCH_CMD --exclude $(echo $patch | xargs)"
            done
          fi
          
          PATCH_CMD="$PATCH_CMD youtube.apk"
          
          echo "Command: $PATCH_CMD"
          echo ""
          
          # Run patching
          eval $PATCH_CMD 2>&1 | tee logs/patching.log
          
          if [ -f "youtube-revanced.apk" ]; then
            echo ""
            echo "âœ… Patching successful!"
            ls -lh youtube-revanced.apk
          else
            echo ""
            echo "âŒ Patching failed! Check logs/patching.log for details"
            cat logs/patching.log
            exit 1
          fi

      - name: Save patched APK
        run: |
          cp youtube-revanced.apk apks/patched/youtube-revanced-${{ github.event.inputs.version }}-arm64-v8a.apk
          echo "âœ… Patched APK saved to apks/patched/"

      - name: Generate build info
        run: |
          cat > apks/BUILD_INFO.md << EOF
          # Build Information
          
          **Build Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          **YouTube Version:** ${{ github.event.inputs.version }}
          **Architecture:** arm64-v8a
          
          ## ReVanced Versions
          $(cat versions.txt)
          
          ## Patch Configuration
          EOF
          
          if [ -n "${{ github.event.inputs.include_patches }}" ]; then
            echo "**Included Patches:** ${{ github.event.inputs.include_patches }}" >> apks/BUILD_INFO.md
          else
            echo "**Patches:** Default recommended patches" >> apks/BUILD_INFO.md
          fi
          
          if [ -n "${{ github.event.inputs.exclude_patches }}" ]; then
            echo "**Excluded Patches:** ${{ github.event.inputs.exclude_patches }}" >> apks/BUILD_INFO.md
          fi
          
          echo "" >> apks/BUILD_INFO.md
          echo "## Files" >> apks/BUILD_INFO.md
          echo '```' >> apks/BUILD_INFO.md
          ls -lh apks/original/ apks/patched/ >> apks/BUILD_INFO.md
          echo '```' >> apks/BUILD_INFO.md
          
          cat apks/BUILD_INFO.md

      - name: Upload logs as artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-${{ github.event.inputs.version }}
          path: logs/
          retention-days: 30

      - name: Commit APKs to repository
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          git add apks/
          
          if git diff --staged --quiet; then
            echo "â„¹ï¸  No changes to commit (APK already exists)"
          else
            git commit -m "ðŸ“¦ Add YouTube v${{ github.event.inputs.version }} APKs

          - Original YouTube APK (arm64-v8a)
          - ReVanced patched APK
          
          Built with:
          $(cat versions.txt | sed 's/^/- /')
          "
            git push
            echo "âœ… APKs committed and pushed to repository"
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ github.event.inputs.version }}
          name: YouTube ReVanced v${{ github.event.inputs.version }}
          body: |
            ## YouTube ReVanced v${{ github.event.inputs.version }}
            
            Automated build of YouTube with ReVanced patches applied.
            
            ### ðŸ“¦ Package Information
            - **YouTube Version:** ${{ github.event.inputs.version }}
            - **Architecture:** arm64-v8a
            - **Build Date:** ${{ github.run_id }}
            
            ### ðŸ”§ ReVanced Components
            Built with latest ReVanced tools (check BUILD_INFO.md for exact versions)
            
            ### ðŸ“¥ Downloads
            - **youtube-revanced-*.apk** - Patched APK (recommended)
            - **youtube-*.apk** - Original unmodified APK
            
            ### ðŸ“± Installation Instructions
            1. Download `youtube-revanced-${{ github.event.inputs.version }}-arm64-v8a.apk`
            2. Uninstall official YouTube app (if installed)
            3. Enable "Install from Unknown Sources" in Android settings
            4. Install the downloaded APK
            5. Sign in with your Google account
            
            ### âš ï¸ Notes
            - This is a modified version of YouTube
            - Use at your own risk
            - Not affiliated with Google or YouTube
            
            ### ðŸ”— Resources
            - [ReVanced Documentation](https://revanced.app/)
            - [Supported Versions](https://github.com/revanced/revanced-patches#-list-of-available-patches)
          files: |
            apks/original/youtube-${{ github.event.inputs.version }}-arm64-v8a.apk
            apks/patched/youtube-revanced-${{ github.event.inputs.version }}-arm64-v8a.apk
            apks/BUILD_INFO.md
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

      - name: Summary
        run: |
          echo "## ðŸŽ‰ Build Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Generated Files" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| File | Size | Location |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|----------|" >> $GITHUB_STEP_SUMMARY
          echo "| Original APK | $(ls -lh apks/original/*.apk | awk '{print $5}') | \`apks/original/\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Patched APK | $(ls -lh apks/patched/*.apk | awk '{print $5}') | \`apks/patched/\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "- Check the [Releases](../../releases) page to download APKs" >> $GITHUB_STEP_SUMMARY
          echo "- Review build logs in the Artifacts section" >> $GITHUB_STEP_SUMMARY
          echo "- APKs are also committed to the \`apks/\` directory" >> $GITHUB_STEP_SUMMARY
