name: rebuild-rogiaitri
on:
  workflow_dispatch:
    inputs:
      apk_url:
        description: 'Direct APK download URL'
        required: true
        type: string

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Install Apktool
        run: |
          mkdir -p bin
          wget -q https://raw.githubusercontent.com/iBotPeaches/Apktool/master/scripts/linux/apktool -O bin/apktool
          JAR_URL=$(curl -s https://api.github.com/repos/iBotPeaches/Apktool/releases/latest | grep browser_download_url | grep jar | cut -d '"' -f 4)
          wget -q "$JAR_URL" -O bin/apktool.jar
          chmod +x bin/apktool bin/apktool.jar
          echo "$GITHUB_WORKSPACE/bin" >> $GITHUB_PATH

      - name: Download and Process APK
        run: |
          # 1. Download original
          curl -L "${{ inputs.apk_url }}" -o original.apk
          
          # 2. Decompile (Strips old signature)
          apktool d original.apk -o src
          
          # 3. Rebuild (Generates a clean, unsigned APK)
          apktool b src -o rebuilt_unsigned.apk

      - name: Align and Sign APK
        env:
          KS_B64: ${{ secrets.KEYSTORE_B64 }}
          KS_PASS: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_PASS: ${{ secrets.KEY_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
        run: |
          # Find the latest build-tools on the runner
          BUILD_TOOLS_DIR=$(ls -d $ANDROID_HOME/build-tools/* | tail -1)
          echo "Using Build Tools from: $BUILD_TOOLS_DIR"
          
          # 1. Align the unsigned APK
          $BUILD_TOOLS_DIR/zipalign -v 4 rebuilt_unsigned.apk aligned.apk
          
          # 2. Decode Keystore
          echo "$KS_B64" | base64 -d > release.keystore
          
          # 3. Sign with new key (v2/v3 scheme)
          $BUILD_TOOLS_DIR/apksigner sign --ks release.keystore \
            --ks-pass pass:"$KS_PASS" \
            --key-pass pass:"$KEY_PASS" \
            --ks-key-alias "$KEY_ALIAS" \
            --out rogiaitri-signed.apk aligned.apk
          
          # 4. Verify
          $BUILD_TOOLS_DIR/apksigner verify rogiaitri-signed.apk

      - name: Create Release and Upload
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "rogiaitri-${{ github.run_id }}"
          name: "RoGiaiTri Rebuilt"
          files: rogiaitri-signed.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
