name: rebuild-rogiaitri
on:
  workflow_dispatch:
    inputs:
      apk_url:
        description: 'Direct APK download URL'
        required: true
        type: string

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Install Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y zipalign
          # Download Apktool
          mkdir -p bin
          wget -q https://raw.githubusercontent.com/iBotPeaches/Apktool/master/scripts/linux/apktool -O bin/apktool
          JAR_URL=$(curl -s https://api.github.com/repos/iBotPeaches/Apktool/releases/latest | grep browser_download_url | grep jar | cut -d '"' -f 4)
          wget -q "$JAR_URL" -O bin/apktool.jar
          chmod +x bin/apktool bin/apktool.jar
          echo "$GITHUB_WORKSPACE/bin" >> $GITHUB_PATH

      - name: Download and Decompile
        run: |
          curl -L "${{ inputs.apk_url }}" -o original.apk
          apktool d original.apk -o src

      - name: Change package name (Basic)
        run: |
          # Warning: This is still likely to cause app crashes without smali/res updates
          sed -i 's/package="[^"]*"/package="com.rogiaitri.db146"/' src/AndroidManifest.xml

      - name: Rebuild APK
        run: apktool b src -o rebuilt_unaligned.apk

      - name: Align and Sign APK
        env:
          KS_B64: ${{ secrets.KEYSTORE_B64 }}
          KS_PASS: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_PASS: ${{ secrets.KEY_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
        run: |
          # Align
          zipalign -v 4 rebuilt_unaligned.apk rebuilt_aligned.apk
          
          # Decode Keystore
          echo "$KS_B64" | base64 -d > release.keystore
          
          # Sign using apksigner (built-in to Ubuntu runners)
          # We use a wildcard to find the latest build-tools version
          BUILD_TOOLS_DIR=$(ls -d $ANDROID_HOME/build-tools/* | tail -1)
          $BUILD_TOOLS_DIR/apksigner sign --ks release.keystore \
            --ks-pass pass:"$KS_PASS" \
            --key-pass pass:"$KEY_PASS" \
            --ks-key-alias "$KEY_ALIAS" \
            --out final-mod.apk rebuilt_aligned.apk

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: "rogiaitri-${{ github.run_id }}"
          name: "RoGiaiTri For FPT Box"
          files: final-mod.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
