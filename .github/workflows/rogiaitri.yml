name: rebuild-rogiaitri
on:
  workflow_dispatch:
    inputs:
      apk_url:
        description: 'Direct APK download URL'
        required: true
        type: string

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Install Apktool
        run: |
          mkdir -p bin
          wget -q https://raw.githubusercontent.com/iBotPeaches/Apktool/master/scripts/linux/apktool -O bin/apktool
          JAR_URL=$(curl -s https://api.github.com/repos/iBotPeaches/Apktool/releases/latest | grep browser_download_url | grep jar | cut -d '"' -f 4)
          wget -q "$JAR_URL" -O bin/apktool.jar
          chmod +x bin/apktool bin/apktool.jar
          echo "$GITHUB_WORKSPACE/bin" >> $GITHUB_PATH

      - name: Download and Decompile
        run: |
          curl -L "${{ inputs.apk_url }}" -o original.apk
          apktool d original.apk -o src

      - name: Rename Package
        run: |
          # 1. Identify the OLD package name automatically from Manifest
          OLD_PKG=$(grep -oP 'package="\K[^"]+' src/AndroidManifest.xml)
          NEW_PKG="com.rogiaitri.db146"
          
          echo "Renaming from $OLD_PKG to $NEW_PKG"
          
          # 2. Create the slash-based paths (used in Smali)
          OLD_PKG_SLASH=$(echo $OLD_PKG | tr '.' '/')
          NEW_PKG_SLASH=$(echo $NEW_PKG | tr '.' '/')
          
          # 3. Replace DOT notation (com.pkg.name) in all files
          # We use 'LC_ALL=C' and 'find' to make it fast and avoid encoding issues
          find src -type f -writable -exec sed -i "s|$OLD_PKG|$NEW_PKG|g" {} +
          
          # 4. Replace SLASH notation (com/pkg/name) in all files
          find src -type f -writable -exec sed -i "s|$OLD_PKG_SLASH|$NEW_PKG_SLASH|g" {} +
          
          echo "Package rename complete."

      - name: Rebuild APK
        run: apktool b src -o rebuilt_unsigned.apk

      - name: Align and Sign APK
        env:
          KS_B64: ${{ secrets.KEYSTORE_B64 }}
          KS_PASS: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_PASS: ${{ secrets.KEY_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
        run: |
          BUILD_TOOLS_DIR=$(ls -d $ANDROID_HOME/build-tools/* | tail -1)
          
          # Align
          $BUILD_TOOLS_DIR/zipalign -v 4 rebuilt_unsigned.apk aligned.apk
          
          # Sign
          echo "$KS_B64" | base64 -d > release.keystore
          $BUILD_TOOLS_DIR/apksigner sign --ks release.keystore \
            --ks-pass pass:"$KS_PASS" \
            --key-pass pass:"$KEY_PASS" \
            --ks-key-alias "$KEY_ALIAS" \
            --out rogiaitri-mod.apk aligned.apk

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "rogiaitri-${{ github.run_id }}"
          name: "RoGiaiTri Modded"
          files: rogiaitri-mod.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
