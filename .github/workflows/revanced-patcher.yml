name: YouTube ReVanced Patcher

on:
  workflow_dispatch:
    inputs:
      apk_url:
        description: 'YouTube APK Download URL (from APKMirror or APKPure) - Required'
        required: true
        type: string
      include_patches:
        description: 'Include specific patches (comma-separated, leave empty for recommended patches)'
        required: false
        type: string
        default: ''
      exclude_patches:
        description: 'Exclude specific patches (comma-separated)'
        required: false
        type: string
        default: ''

jobs:
  patch-youtube:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Download YouTube APK
        id: download
        run: |
          echo "ðŸ“¥ Downloading APK from provided URL..."
          
          # Download with better error handling
          wget --user-agent="Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36" \
               --timeout=120 \
               --tries=5 \
               --no-check-certificate \
               -O youtube.apk "${{ github.event.inputs.apk_url }}"
          
          if [ $? -ne 0 ]; then
            echo "âŒ Download failed with wget, trying curl..."
            curl -L --retry 5 --retry-delay 3 \
                 -H "User-Agent: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36" \
                 -o youtube.apk "${{ github.event.inputs.apk_url }}"
          fi
          
          if [ ! -f youtube.apk ] || [ ! -s youtube.apk ]; then
            echo "âŒ Download failed or file is empty!"
            exit 1
          fi
          
          echo "âœ… APK downloaded successfully"
          echo ""
          echo "ðŸ“Š APK Info:"
          ls -lh youtube.apk
          
          # Extract version from APK using aapt
          echo ""
          echo "ðŸ” Extracting version info..."

      - name: Extract APK version
        id: version
        run: |
          # Try multiple methods to extract version
          
          # Method 1: Try using aapt if available
          if command -v aapt &> /dev/null; then
            VERSION=$(aapt dump badging youtube.apk | grep "versionName" | sed "s/.*versionName='//" | sed "s/'.*//")
            echo "Extracted version with aapt: $VERSION"
          fi
          
          # Method 2: Extract from filename if aapt fails
          if [ -z "$VERSION" ]; then
            VERSION=$(echo "${{ github.event.inputs.apk_url }}" | grep -oP 'youtube-\K[0-9.]+' | head -1)
            echo "Extracted version from URL: $VERSION"
          fi
          
          # Method 3: Unzip and check AndroidManifest.xml
          if [ -z "$VERSION" ]; then
            unzip -p youtube.apk AndroidManifest.xml > manifest.xml 2>/dev/null || true
            # Try to extract version from binary XML (basic attempt)
            VERSION=$(strings manifest.xml | grep -oP '\d+\.\d+\.\d+' | head -1)
            echo "Extracted version from manifest: $VERSION"
          fi
          
          # Fallback to timestamp if all fails
          if [ -z "$VERSION" ]; then
            VERSION=$(date +%Y%m%d-%H%M%S)
            echo "âš ï¸  Could not extract version, using timestamp: $VERSION"
          fi
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo ""
          echo "âœ… Version: $VERSION"

      - name: Verify APK integrity
        run: |
          echo "ðŸ” Verifying APK..."
          
          # Check file size (should be at least 50MB for YouTube)
          SIZE=$(stat -f%z youtube.apk 2>/dev/null || stat -c%s youtube.apk 2>/dev/null)
          if [ "$SIZE" -lt 50000000 ]; then
            echo "âš ï¸  Warning: APK size is unusually small ($(numfmt --to=iec $SIZE))"
            echo "This might not be a valid APK file."
          fi
          
          # Check if file is a valid ZIP (APK is a ZIP file)
          if file youtube.apk | grep -q "Zip archive\|Android"; then
            echo "âœ… APK file format is valid"
          else
            echo "âš ï¸  Warning: File type check failed, but continuing..."
            file youtube.apk
          fi
          
          # Try to list APK contents
          if unzip -l youtube.apk > /dev/null 2>&1; then
            echo "âœ… APK structure is valid"
            echo ""
            echo "ðŸ“¦ APK contents preview:"
            unzip -l youtube.apk | head -20
          else
            echo "âŒ APK structure validation failed!"
            echo "The downloaded file may be corrupted or not a valid APK."
            echo ""
            echo "File details:"
            file youtube.apk
            hexdump -C youtube.apk | head -20
            exit 1
          fi

      - name: Create directories
        run: |
          mkdir -p apks/original
          mkdir -p apks/patched
          mkdir -p logs

      - name: Save original APK
        run: |
          cp youtube.apk apks/original/youtube-${{ steps.version.outputs.version }}-arm64-v8a.apk
          echo "âœ… Original APK saved to apks/original/"

      - name: Download ReVanced tools
        run: |
          echo "ðŸ“¥ Downloading ReVanced tools..."
          echo ""
          
          echo "Fetching ReVanced CLI..."
          CLI_URL=$(curl -s https://api.github.com/repos/revanced/revanced-cli/releases/latest | \
                    jq -r '.assets[] | select(.name | endswith(".jar")) | .browser_download_url')
          CLI_VERSION=$(curl -s https://api.github.com/repos/revanced/revanced-cli/releases/latest | jq -r '.tag_name')
          echo "Version: $CLI_VERSION"
          wget -q --show-progress -O revanced-cli.jar "$CLI_URL"
          
          echo ""
          echo "Fetching ReVanced Patches..."
          PATCHES_URL=$(curl -s https://api.github.com/repos/revanced/revanced-patches/releases/latest | \
                        jq -r '.assets[] | select(.name | endswith(".rvp")) | .browser_download_url')
          PATCHES_VERSION=$(curl -s https://api.github.com/repos/revanced/revanced-patches/releases/latest | jq -r '.tag_name')
          echo "Version: $PATCHES_VERSION"
          wget -q --show-progress -O revanced-patches.rvp "$PATCHES_URL"
          
          # Note: Integrations download removed as it is usually bundled or not needed as a separate merge arg in new CLI
          
          echo ""
          echo "âœ… ReVanced tools downloaded"
          echo ""
          echo "ðŸ“Š Downloaded files:"
          ls -lh revanced-cli.jar revanced-patches.rvp
          
          # Save versions to file
          echo "CLI_VERSION=$CLI_VERSION" >> versions.txt
          echo "PATCHES_VERSION=$PATCHES_VERSION" >> versions.txt

      - name: List available patches
        run: |
          echo "ðŸ“‹ Available patches for YouTube:"
          java -jar revanced-cli.jar list-patches \
            --with-packages \
            --with-versions \
            revanced-patches.rvp | grep -i youtube | tee logs/available-patches.txt

      - name: Patch YouTube APK with ReVanced
        run: |
          echo "ðŸ”§ Starting patching process..."
          echo ""
          
          # Build patch command
          # UPDATED: Use --patches instead of --patch-bundle, remove --merge
          PATCH_CMD="java -jar revanced-cli.jar patch"
          PATCH_CMD="$PATCH_CMD --patches revanced-patches.rvp"
          PATCH_CMD="$PATCH_CMD --out youtube-revanced.apk"
          
          # Add include patches if specified
          if [ -n "${{ github.event.inputs.include_patches }}" ]; then
            echo "Including specific patches: ${{ github.event.inputs.include_patches }}"
            IFS=',' read -ra PATCHES <<< "${{ github.event.inputs.include_patches }}"
            for patch in "${PATCHES[@]}"; do
              PATCH_CMD="$PATCH_CMD --include $(echo $patch | xargs)"
            done
          fi
          
          # Add exclude patches if specified
          if [ -n "${{ github.event.inputs.exclude_patches }}" ]; then
            echo "Excluding patches: ${{ github.event.inputs.exclude_patches }}"
            IFS=',' read -ra PATCHES <<< "${{ github.event.inputs.exclude_patches }}"
            for patch in "${PATCHES[@]}"; do
              PATCH_CMD="$PATCH_CMD --exclude $(echo $patch | xargs)"
            done
          fi
          
          PATCH_CMD="$PATCH_CMD youtube.apk"
          
          echo "Command: $PATCH_CMD"
          echo ""
          
          # Run patching
          eval $PATCH_CMD 2>&1 | tee logs/patching.log
          
          if [ -f "youtube-revanced.apk" ]; then
            echo ""
            echo "âœ… Patching successful!"
            ls -lh youtube-revanced.apk
          else
            echo ""
            echo "âŒ Patching failed! Check logs/patching.log for details"
            cat logs/patching.log
            exit 1
          fi

      - name: Save patched APK
        run: |
          # FIXED: Used steps.version.outputs.version instead of inputs.version
          cp youtube-revanced.apk apks/patched/youtube-revanced-${{ steps.version.outputs.version }}-arm64-v8a.apk
          echo "âœ… Patched APK saved to apks/patched/"

      - name: Generate build info
        run: |
          cat > apks/BUILD_INFO.md << EOF
          # Build Information
          
          **Build Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          **YouTube Version:** ${{ steps.version.outputs.version }}
          **Architecture:** arm64-v8a
          
          ## ReVanced Versions
          $(cat versions.txt)
          
          ## Patch Configuration
          EOF
          
          if [ -n "${{ github.event.inputs.include_patches }}" ]; then
            echo "**Included Patches:** ${{ github.event.inputs.include_patches }}" >> apks/BUILD_INFO.md
          else
            echo "**Patches:** Default recommended patches" >> apks/BUILD_INFO.md
          fi
          
          if [ -n "${{ github.event.inputs.exclude_patches }}" ]; then
            echo "**Excluded Patches:** ${{ github.event.inputs.exclude_patches }}" >> apks/BUILD_INFO.md
          fi
          
          echo "" >> apks/BUILD_INFO.md
          echo "## Files" >> apks/BUILD_INFO.md
          echo '```' >> apks/BUILD_INFO.md
          ls -lh apks/original/ apks/patched/ >> apks/BUILD_INFO.md
          echo '```' >> apks/BUILD_INFO.md
          
          cat apks/BUILD_INFO.md

      - name: Upload logs as artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          # FIXED: Used steps.version.outputs.version
          name: build-logs-${{ steps.version.outputs.version }}
          path: logs/
          retention-days: 30

      - name: Commit APKs to repository
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          git add apks/
          
          if git diff --staged --quiet; then
            echo "â„¹ï¸  No changes to commit (APK already exists)"
          else
            # FIXED: Used steps.version.outputs.version
            git commit -m "ðŸ“¦ Add YouTube v${{ steps.version.outputs.version }} APKs

          - Original YouTube APK (arm64-v8a)
          - ReVanced patched APK
          
          Built with:
          $(cat versions.txt | sed 's/^/- /')
          "
            git push
            echo "âœ… APKs committed and pushed to repository"
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          # FIXED: Used steps.version.outputs.version everywhere below
          tag_name: v${{ steps.version.outputs.version }}
          name: YouTube ReVanced v${{ steps.version.outputs.version }}
          body: |
            ## YouTube ReVanced v${{ steps.version.outputs.version }}
            
            Automated build of YouTube with ReVanced patches applied.
            
            ### ðŸ“¦ Package Information
            - **YouTube Version:** ${{ steps.version.outputs.version }}
            - **Architecture:** arm64-v8a
            - **Build Date:** ${{ github.run_id }}
            
            ### ðŸ”§ ReVanced Components
            Built with latest ReVanced tools (check BUILD_INFO.md for exact versions)
            
            ### ðŸ“¥ Downloads
            - **youtube-revanced-*.apk** - Patched APK (recommended)
            - **youtube-*.apk** - Original unmodified APK
            
            ### ðŸ“± Installation Instructions
            1. Download `youtube-revanced-${{ steps.version.outputs.version }}-arm64-v8a.apk`
            2. Uninstall official YouTube app (if installed)
            3. Enable "Install from Unknown Sources" in Android settings
            4. Install the downloaded APK
            5. Sign in with your Google account
            
            ### âš ï¸ Notes
            - This is a modified version of YouTube
            - Use at your own risk
            - Not affiliated with Google or YouTube
            
            ### ðŸ”— Resources
            - [ReVanced Documentation](https://revanced.app/)
            - [Supported Versions](https://github.com/revanced/revanced-patches#-list-of-available-patches)
          files: |
            apks/original/youtube-${{ steps.version.outputs.version }}-arm64-v8a.apk
            apks/patched/youtube-revanced-${{ steps.version.outputs.version }}-arm64-v8a.apk
            apks/BUILD_INFO.md
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

      - name: Summary
        run: |
          echo "## ðŸŽ‰ Build Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Generated Files" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| File | Size | Location |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|----------|" >> $GITHUB_STEP_SUMMARY
          echo "| Original APK | $(ls -lh apks/original/*.apk | awk '{print $5}') | \`apks/original/\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Patched APK | $(ls -lh apks/patched/*.apk | awk '{print $5}') | \`apks/patched/\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "- Check the [Releases](../../releases) page to download APKs" >> $GITHUB_STEP_SUMMARY
          echo "- Review build logs in the Artifacts section" >> $GITHUB_STEP_SUMMARY
          echo "- APKs are also committed to the \`apks/\` directory" >> $GITHUB_STEP_SUMMARY
