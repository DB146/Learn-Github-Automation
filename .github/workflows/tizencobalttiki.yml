name: rebuild-cobalt

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Get latest release metadata
        id: latest
        uses: actions/github-script@v7
        with:
          result-encoding: string
          script: |
            const res = await github.rest.repos.getLatestRelease({
              owner: "reisxd",
              repo: "TizenTubeCobalt"
            });
            const asset = res.data.assets.find(a => a.name.endsWith("arm.apk"));
            return asset.browser_download_url;

      - name: Download and Setup Tools
        run: |
          curl -L "${{ steps.latest.outputs.result }}" -o cobalt.apk
          # Download Apktool
          wget https://github.com/iBotPeaches/Apktool/releases/download/v2.9.3/apktool_2.9.3.jar -O apktool.jar
          # Find build-tools path
          BUILD_TOOLS_PATH=$(ls -d $ANDROID_HOME/build-tools/* | tail -1)
          echo "BUILD_TOOLS_PATH=$BUILD_TOOLS_PATH" >> $GITHUB_ENV

      - name: Decompile and Patch
        run: |
          java -jar apktool.jar d cobalt.apk -o cobalt_src
          # Update Manifest
          sed -i 's/package="[^"]*"/package="com.teamsmart.videomanager.tv"/' cobalt_src/AndroidManifest.xml
          # Update apktool.yml to match
          sed -i 's/cur_package: .*/cur_package: com.teamsmart.videomanager.tv/' cobalt_src/apktool.yml

      - name: Recompile
        run: java -jar apktool.jar b cobalt_src -o rebuilt_unaligned.apk

      - name: Zipalign
        run: ${{ env.BUILD_TOOLS_PATH }}/zipalign -v 4 rebuilt_unaligned.apk rebuilt_aligned.apk

      - name: Sign APK (V2/V3)
        run: |
          echo "${{ secrets.KEYSTORE_B64 }}" | base64 -d > release.keystore
          ${{ env.BUILD_TOOLS_PATH }}/apksigner sign --ks release.keystore \
            --ks-pass pass:"${{ secrets.KEYSTORE_PASSWORD }}" \
            --ks-key-alias "${{ secrets.KEY_ALIAS }}" \
            --key-pass pass:"${{ secrets.KEY_PASSWORD }}" \
            --out cobalt-mod.apk rebuilt_aligned.apk

      - name: Create Release and Upload
        uses: softprops/action-gh-release@v1
        with:
          tag_name: "auto-${{ github.run_id }}"
          files: cobalt-mod.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
