name: YouTube ReVanced Patcher 2

on:
  workflow_dispatch:
    inputs:
      apk_url:
        description: 'YouTube APK Download URL (leave empty for auto-detection)'
        required: false
        type: string
        default: ''
      include_patches:
        description: 'Include specific patches (comma-separated, leave empty for recommended patches)'
        required: false
        type: string
        default: ''
      exclude_patches:
        description: 'Exclude specific patches (comma-separated)'
        required: false
        type: string
        default: ''

jobs:
  patch-youtube:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Detect latest compatible YouTube version
        id: detect_version
        run: |
          echo "ðŸ” Detecting latest compatible YouTube version from ReVanced patches..."
          echo ""
          
          # Download the HideAdsPatch.kt file to extract compatible versions
          PATCH_URL="https://raw.githubusercontent.com/ReVanced/revanced-patches/refs/heads/main/patches/src/main/kotlin/app/revanced/patches/youtube/ad/general/HideAdsPatch.kt"
          
          echo "ðŸ“¥ Fetching patch compatibility info..."
          curl -s "$PATCH_URL" -o HideAdsPatch.kt
          
          # Extract versions from compatibleWith block
          echo "ðŸ“‹ Extracting compatible versions..."
          VERSIONS=$(grep -A 10 'compatibleWith(' HideAdsPatch.kt | \
                     grep '"[0-9]' | \
                     sed 's/.*"\([0-9.]*\)".*/\1/' | \
                     sort -V)
          
          echo "Compatible versions found:"
          echo "$VERSIONS"
          echo ""
          
          # Get the latest version (last in sorted list)
          LATEST_VERSION=$(echo "$VERSIONS" | tail -1)
          
          echo "âœ… Latest compatible version: $LATEST_VERSION"
          echo "version=$LATEST_VERSION" >> $GITHUB_OUTPUT
          
          # Clean up
          rm -f HideAdsPatch.kt

      - name: Find and download YouTube APK
        id: download
        run: |
          VERSION="${{ steps.detect_version.outputs.version }}"
          
          if [ -n "${{ github.event.inputs.apk_url }}" ]; then
            echo "ðŸ“¥ Using provided APK URL..."
            APK_URL="${{ github.event.inputs.apk_url }}"
          else
            echo "ðŸ” Auto-detecting APK download URL for version $VERSION..."
            echo ""
            
            # Try APKMirror first (most reliable for YouTube)
            echo "Searching APKMirror..."
            
            # Format version for URL (e.g., 20.14.43 -> 20-14-43)
            VERSION_FORMATTED=$(echo "$VERSION" | sed 's/\./-/g')
            
            # Construct APKMirror URL patterns to try
            YEAR=$(date +%Y)
            
            # Try multiple APKMirror URL patterns
            APK_URLS=(
              "https://www.apkmirror.com/apk/google-inc/youtube/youtube-${VERSION}-release/youtube-${VERSION}-android-apk-download/"
              "https://www.apkmirror.com/apk/google-inc/youtube/youtube-${VERSION}-release/youtube-${VERSION}-2-android-apk-download/"
              "https://d.apkpure.com/b/XAPK/com.google.android.youtube?version=${VERSION}"
              "https://d.apkpure.net/b/APK/com.google.android.youtube?versionCode=$(echo $VERSION | sed 's/\.//g')"
            )
            
            # For APKMirror, we need to construct the download URL differently
            echo "Attempting to fetch download page from APKMirror..."
            
            # Search APKMirror for the version
            SEARCH_URL="https://www.apkmirror.com/?post_type=app_release&searchtype=apk&s=youtube+${VERSION}"
            DOWNLOAD_PAGE=$(curl -sL "$SEARCH_URL" | \
                           grep -o 'href="[^"]*youtube-'${VERSION}'[^"]*"' | \
                           head -1 | \
                           sed 's/href="//;s/"//')
            
            if [ -n "$DOWNLOAD_PAGE" ]; then
              echo "Found download page: https://www.apkmirror.com${DOWNLOAD_PAGE}"
              
              # Get the actual download link
              APK_URL=$(curl -sL "https://www.apkmirror.com${DOWNLOAD_PAGE}" | \
                       grep -o 'href="[^"]*key=[^"]*"' | \
                       head -1 | \
                       sed 's/href="//;s/"//')
              
              if [ -n "$APK_URL" ]; then
                APK_URL="https://www.apkmirror.com${APK_URL}"
                echo "âœ… Found APK download URL: $APK_URL"
              fi
            fi
            
            # Fallback to APKPure if APKMirror fails
            if [ -z "$APK_URL" ]; then
              echo "âš ï¸  APKMirror detection failed, trying APKPure..."
              
              # Try APKPure direct download
              APK_URL="https://d.apkpure.com/b/APK/com.google.android.youtube?version=${VERSION}"
              
              echo "Trying APKPure URL: $APK_URL"
              
              # Test if URL is valid
              HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$APK_URL")
              if [ "$HTTP_CODE" != "200" ]; then
                echo "âŒ APKPure direct download failed"
                APK_URL=""
              fi
            fi
            
            # If all auto-detection fails, provide manual instructions
            if [ -z "$APK_URL" ]; then
              echo "âŒ Could not auto-detect APK download URL"
              echo ""
              echo "Please manually provide the APK URL by:"
              echo "1. Visit https://www.apkmirror.com/apk/google-inc/youtube/"
              echo "2. Find version $VERSION"
              echo "3. Download the APK (choose arm64-v8a + armeabi-v7a variant)"
              echo "4. Re-run this workflow with the download URL"
              exit 1
            fi
          fi
          
          echo ""
          echo "ðŸ“¥ Downloading YouTube APK version $VERSION..."
          echo "URL: $APK_URL"
          echo ""
          
          # Download with better error handling
          wget --user-agent="Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36" \
               --timeout=120 \
               --tries=5 \
               --no-check-certificate \
               -O youtube.apk "$APK_URL"
          
          if [ $? -ne 0 ]; then
            echo "âŒ Download failed with wget, trying curl..."
            curl -L --retry 5 --retry-delay 3 \
                 -H "User-Agent: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36" \
                 -o youtube.apk "$APK_URL"
          fi
          
          if [ ! -f youtube.apk ] || [ ! -s youtube.apk ]; then
            echo "âŒ Download failed or file is empty!"
            echo ""
            echo "Please manually download YouTube $VERSION APK from:"
            echo "- APKMirror: https://www.apkmirror.com/apk/google-inc/youtube/"
            echo "- APKPure: https://apkpure.com/youtube/com.google.android.youtube"
            echo ""
            echo "Then re-run this workflow with the download URL"
            exit 1
          fi
          
          echo "âœ… APK downloaded successfully"
          echo ""
          echo "ðŸ“Š APK Info:"
          ls -lh youtube.apk

      - name: Extract APK version
        id: version
        run: |
          # Use the detected version from earlier step
          VERSION="${{ steps.detect_version.outputs.version }}"
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo ""
          echo "âœ… Using Version: $VERSION"

      - name: Verify APK integrity
        run: |
          echo "ðŸ” Verifying APK..."
          
          # Check file size (should be at least 50MB for YouTube)
          SIZE=$(stat -c%s youtube.apk 2>/dev/null || stat -f%z youtube.apk 2>/dev/null)
          if [ "$SIZE" -lt 50000000 ]; then
            echo "âš ï¸  Warning: APK size is unusually small ($(numfmt --to=iec $SIZE 2>/dev/null || echo $SIZE bytes))"
            echo "This might not be a valid APK file."
          fi
          
          # Check if file is a valid ZIP (APK is a ZIP file)
          if file youtube.apk | grep -q "Zip archive\|Android"; then
            echo "âœ… APK file format is valid"
          else
            echo "âš ï¸  Warning: File type check failed, but continuing..."
            file youtube.apk
          fi
          
          # Try to list APK contents
          if unzip -l youtube.apk > /dev/null 2>&1; then
            echo "âœ… APK structure is valid"
            echo ""
            echo "ðŸ“¦ APK contents preview:"
            unzip -l youtube.apk | head -20
          else
            echo "âŒ APK structure validation failed!"
            echo "The downloaded file may be corrupted or not a valid APK."
            echo ""
            echo "File details:"
            file youtube.apk
            hexdump -C youtube.apk | head -20
            exit 1
          fi

      - name: Create directories
        run: |
          mkdir -p apks/original
          mkdir -p apks/patched
          mkdir -p logs

      - name: Save original APK
        run: |
          cp youtube.apk apks/original/youtube-${{ steps.version.outputs.version }}-arm64-v8a.apk
          echo "âœ… Original APK saved to apks/original/"

      - name: Download ReVanced tools
        run: |
          echo "ðŸ“¥ Downloading ReVanced tools..."
          echo ""
          
          echo "Fetching ReVanced CLI..."
          CLI_URL=$(curl -s https://api.github.com/repos/revanced/revanced-cli/releases/latest | \
                    jq -r '.assets[] | select(.name | endswith(".jar")) | .browser_download_url')
          CLI_VERSION=$(curl -s https://api.github.com/repos/revanced/revanced-cli/releases/latest | jq -r '.tag_name')
          echo "Version: $CLI_VERSION"
          wget -q --show-progress -O revanced-cli.jar "$CLI_URL"
          
          echo ""
          echo "Fetching ReVanced Patches..."
          PATCHES_URL=$(curl -s https://api.github.com/repos/revanced/revanced-patches/releases/latest | \
                        jq -r '.assets[] | select(.name | endswith(".rvp")) | .browser_download_url')
          PATCHES_VERSION=$(curl -s https://api.github.com/repos/revanced/revanced-patches/releases/latest | jq -r '.tag_name')
          echo "Version: $PATCHES_VERSION"
          wget -q --show-progress -O revanced-patches.rvp "$PATCHES_URL"
          
          echo ""
          echo "âœ… ReVanced tools downloaded"
          echo ""
          echo "ðŸ“Š Downloaded files:"
          ls -lh revanced-cli.jar revanced-patches.rvp
          
          # Save versions to file
          echo "CLI_VERSION=$CLI_VERSION" >> versions.txt
          echo "PATCHES_VERSION=$PATCHES_VERSION" >> versions.txt

      - name: List available patches
        run: |
          echo "ðŸ“‹ Available patches for YouTube:"
          java -jar revanced-cli.jar list-patches \
            --with-packages \
            --with-versions \
            revanced-patches.rvp | grep -i youtube | tee logs/available-patches.txt

      - name: Patch YouTube APK with ReVanced
        run: |
          echo "ðŸ”§ Starting patching process..."
          echo ""
          
          # Build patch command
          PATCH_CMD="java -jar revanced-cli.jar patch"
          PATCH_CMD="$PATCH_CMD --patches revanced-patches.rvp"
          PATCH_CMD="$PATCH_CMD --out youtube-revanced.apk"
          
          # Add include patches if specified
          if [ -n "${{ github.event.inputs.include_patches }}" ]; then
            echo "Including specific patches: ${{ github.event.inputs.include_patches }}"
            IFS=',' read -ra PATCHES <<< "${{ github.event.inputs.include_patches }}"
            for patch in "${PATCHES[@]}"; do
              PATCH_CMD="$PATCH_CMD --include $(echo $patch | xargs)"
            done
          fi
          
          # Add exclude patches if specified
          if [ -n "${{ github.event.inputs.exclude_patches }}" ]; then
            echo "Excluding patches: ${{ github.event.inputs.exclude_patches }}"
            IFS=',' read -ra PATCHES <<< "${{ github.event.inputs.exclude_patches }}"
            for patch in "${PATCHES[@]}"; do
              PATCH_CMD="$PATCH_CMD --exclude $(echo $patch | xargs)"
            done
          fi
          
          PATCH_CMD="$PATCH_CMD youtube.apk"
          
          echo "Command: $PATCH_CMD"
          echo ""
          
          # Run patching
          eval $PATCH_CMD 2>&1 | tee logs/patching.log
          
          if [ -f "youtube-revanced.apk" ]; then
            echo ""
            echo "âœ… Patching successful!"
            ls -lh youtube-revanced.apk
          else
            echo ""
            echo "âŒ Patching failed! Check logs/patching.log for details"
            cat logs/patching.log
            exit 1
          fi

      - name: Save patched APK
        run: |
          cp youtube-revanced.apk apks/patched/youtube-revanced-${{ steps.version.outputs.version }}-arm64-v8a.apk
          echo "âœ… Patched APK saved to apks/patched/"

      - name: Generate build info
        run: |
          cat > apks/BUILD_INFO.md << EOF
          # Build Information
          
          **Build Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          **YouTube Version:** ${{ steps.version.outputs.version }}
          **Architecture:** arm64-v8a
          **Auto-detected:** Yes
          
          ## ReVanced Versions
          $(cat versions.txt)
          
          ## Patch Configuration
          EOF
          
          if [ -n "${{ github.event.inputs.include_patches }}" ]; then
            echo "**Included Patches:** ${{ github.event.inputs.include_patches }}" >> apks/BUILD_INFO.md
          else
            echo "**Patches:** Default recommended patches" >> apks/BUILD_INFO.md
          fi
          
          if [ -n "${{ github.event.inputs.exclude_patches }}" ]; then
            echo "**Excluded Patches:** ${{ github.event.inputs.exclude_patches }}" >> apks/BUILD_INFO.md
          fi
          
          echo "" >> apks/BUILD_INFO.md
          echo "## Files" >> apks/BUILD_INFO.md
          echo '```' >> apks/BUILD_INFO.md
          ls -lh apks/original/ apks/patched/ >> apks/BUILD_INFO.md
          echo '```' >> apks/BUILD_INFO.md
          
          cat apks/BUILD_INFO.md

      - name: Upload logs as artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-${{ steps.version.outputs.version }}
          path: logs/
          retention-days: 30

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: YouTube ReVanced v${{ steps.version.outputs.version }}
          body: |
            ## YouTube ReVanced v${{ steps.version.outputs.version }}
            
            Automated build of YouTube with ReVanced patches applied.
            
            ### ðŸ“¦ Package Information
            - **YouTube Version:** ${{ steps.version.outputs.version }}
            - **Architecture:** arm64-v8a
            - **Build Date:** ${{ github.run_id }}
            - **Auto-detected Version:** Yes
            
            ### ðŸ”§ ReVanced Components
            Built with latest ReVanced tools (check BUILD_INFO.md for exact versions)
            
            ### ðŸ“¥ Downloads
            - **youtube-revanced-*.apk** - Patched APK (recommended)
            - **youtube-*.apk** - Original unmodified APK
            
            ### ðŸ“± Installation Instructions
            1. Download `youtube-revanced-${{ steps.version.outputs.version }}-arm64-v8a.apk`
            2. Uninstall official YouTube app (if installed)
            3. Enable "Install from Unknown Sources" in Android settings
            4. Install the downloaded APK
            5. Sign in with your Google account
            
            ### âš ï¸ Notes
            - This is a modified version of YouTube
            - Use at your own risk
            - Not affiliated with Google or YouTube
            - This version was auto-detected from ReVanced patches compatibility
            
            ### ðŸ”— Resources
            - [ReVanced Documentation](https://revanced.app/)
            - [Supported Versions](https://github.com/revanced/revanced-patches#-list-of-available-patches)
          files: |
            apks/original/youtube-${{ steps.version.outputs.version }}-arm64-v8a.apk
            apks/patched/youtube-revanced-${{ steps.version.outputs.version }}-arm64-v8a.apk
            apks/BUILD_INFO.md
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

      - name: Summary
        run: |
          echo "## ðŸŽ‰ Build Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Build Details" >> $GITHUB_STEP_SUMMARY
          echo "- **YouTube Version:** ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Auto-detected:** Yes" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Generated Files" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| File | Size | Location |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|----------|" >> $GITHUB_STEP_SUMMARY
          echo "| Original APK | $(ls -lh apks/original/*.apk | awk '{print $5}') | \`apks/original/\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Patched APK | $(ls -lh apks/patched/*.apk | awk '{print $5}') | \`apks/patched/\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "- Check the [Releases](../../releases) page to download APKs" >> $GITHUB_STEP_SUMMARY
          echo "- Review build logs in the Artifacts section" >> $GITHUB_STEP_SUMMARY
          echo "- APKs are also committed to the \`apks/\` directory" >> $GITHUB_STEP_SUMMARY
